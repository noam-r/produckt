version: '3.8'

services:
  backend:
    environment:
      - ENVIRONMENT=production
      - LOG_LEVEL=INFO
      - SESSION_COOKIE_SECURE=true
      - SESSION_COOKIE_HTTPONLY=true
      - SESSION_COOKIE_SAMESITE=strict
    volumes:
      # Remove source code mounts for production
      - produck-data:/app/data
    # Temporarily disable read-only for testing
    # read_only: true
    tmpfs:
      - /tmp
      - /run
    deploy:
      resources:
        limits:
          cpus: '${BACKEND_CPU_LIMIT:-1.0}'
          memory: ${BACKEND_MEMORY_LIMIT:-1G}
    restart: unless-stopped

  frontend:
    build:
      target: production
    ports:
      - "5173:80"
    volumes:
      # Remove source code mounts for production
      []
    # Temporarily disable read-only for testing
    # read_only: true
    tmpfs:
      - /tmp
      - /var/cache/nginx
      - /var/run
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    # Temporarily remove depends_on due to docker-compose 1.29.2 bug
    depends_on: []
    deploy:
      resources:
        limits:
          cpus: '${FRONTEND_CPU_LIMIT:-0.5}'
          memory: ${FRONTEND_MEMORY_LIMIT:-512M}
    restart: unless-stopped

  # Optional PostgreSQL service with production resource limits
  # db:
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '${POSTGRES_CPU_LIMIT:-1.0}'
  #         memory: ${POSTGRES_MEMORY_LIMIT:-2G}
  #       reservations:
  #         cpus: '${POSTGRES_CPU_RESERVATION:-0.5}'
  #         memory: ${POSTGRES_MEMORY_RESERVATION:-1G}
  #   restart: unless-stopped
